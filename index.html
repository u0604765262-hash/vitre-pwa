<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bulle de Savon - Nettoyage Vitres</title>

  <!-- ✅ Favicon (conservé) -->
  <link rel="icon" href="logo1.png" type="image/png">
  <meta name="theme-color" content="#0F384D">

  <!-- ✅ Police Antic Slab -->
  <link href="https://fonts.googleapis.com/css2?family=Antic+Slab&display=swap" rel="stylesheet">
  <!-- ✅ Flatpickr (calendrier/heure avec jours/horaires grisés) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    :root {
      /* Palette existante (inchangée) */
      --primary: #0F384D;
      --primary-600: #0C2C3A;
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #2b2b2b;
      --muted: #6b7280;
      --success: #22c55e;
      --danger: #ef4444;
      --shadow: 0 6px 18px rgba(0,0,0,0.08);
      --radius: 14px;

      /* ✅ Nouvelles touches de couleurs douces (complémentaires) */
      --teal-50:#e6f7f4; --teal-200:#c9eee8; --teal-700:#0b766e;
      --sky-50:#e8f5ff; --sky-200:#cfeafd; --sky-700:#0b6ea9;
      --amber-50:#fff6e5; --amber-200:#ffe6b8; --amber-700:#9a6700;
      --rose-50:#fff0f3; --rose-200:#ffd6dd; --rose-700:#a61b3c;
      --slate-50:#f8fafc; --slate-200:#eef2f7; --slate-700:#0f172a;
      --glass: rgba(255,255,255,.6);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: 'Antic Slab', serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      font-size: 17px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a { color: var(--primary); text-decoration: none; }
    img { max-width: 100%; display: block; }
    .container { width: min(1100px, 92%); margin: 0 auto; }

    /* Header */
    header {
      position: sticky; top: 0; z-index: 50; background: rgba(255,255,255,.9);
      backdrop-filter: saturate(150%) blur(6px);
      border-bottom: 1px solid var(--slate-200);
    }
    .nav { display:flex; align-items:center; justify-content:space-between; gap:16px; padding:10px 0; }
    .brand { display:flex; align-items:center; gap:12px; }
    .brand img { max-height: 150px; height: auto; width: auto; }
    .cta-header { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 18px; border-radius: 999px; font-weight: 700; border: 0; cursor:pointer;
      transition: .2s transform ease, .25s box-shadow ease, .2s background-color ease; box-shadow: var(--shadow);
      font-family:'Antic Slab', serif;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:focus-visible { outline: 3px solid rgba(15,56,77,.25); outline-offset: 2px; }

    .btn-primary { background: var(--primary); color: #fff; border: 2px solid transparent; }
    .btn-primary:hover { background: var(--primary-600); }
    .btn-ghost { background: #fff; color: var(--primary); border:2px solid rgba(15,56,77,.15); }

    /* Hero */
    .hero { position: relative; background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%); padding: 42px 0 28px; border-bottom: 1px solid #eef2f7; overflow:hidden; }
    .hero::before{
      content:""; position:absolute; inset:-20% -10% auto -10%; height: 120%;
      background:
        radial-gradient(120px 120px at 10% 20%, rgba(11,118,110,.08), transparent 60%),
        radial-gradient(140px 140px at 90% 10%, rgba(11,110,169,.07), transparent 60%),
        radial-gradient(110px 110px at 80% 80%, rgba(154,103,0,.06), transparent 60%),
        radial-gradient(90px 90px   at 20% 85%, rgba(166,27,60,.06), transparent 60%);
      pointer-events:none;
    }
    .hero-grid { display:grid; grid-template-columns: 1.15fr .85fr; gap: 28px; align-items:center; }
    .hero h2 { font-size: clamp(22px, 3vw, 32px); margin: 0 0 10px; color: var(--primary); letter-spacing:.2px; }
    .hero p.lead { font-size: clamp(16px, 2vw, 19px); color:#475569; margin: 0 0 18px; }
    .hero .badges { display:flex; gap:10px; flex-wrap:wrap; margin: 14px 0 18px; }
    .badge { border:1px solid var(--slate-200); padding:8px 12px; border-radius:999px; font-weight:700; font-size:14px; font-family:'Antic Slab', serif; }
    .badge:nth-child(1){ background:var(--teal-50); border-color:var(--teal-200); color:var(--teal-700); }
    .badge:nth-child(2){ background:var(--sky-50); border-color:var(--sky-200); color:var(--sky-700); }
    .badge:nth-child(3){ background:var(--amber-50); border-color:var(--amber-200); color:var(--amber-700); }

    .hero-card { background: var(--card); padding:18px; border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid var(--slate-200);
      position:relative; isolation:isolate; }
    .hero-card::after{ content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
      background: linear-gradient(135deg, rgba(15,56,77,.06), transparent 40%); mix-blend: multiply; }
    .usp { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .usp .item { display:flex; align-items:flex-start; gap:10px; background:#f9fbfd; border:1px solid #e6eef5; padding:12px; border-radius:12px; }
    .usp .item .icon { font-size:20px; }

    section { padding: 32px 0; }
    .section-title { font-size: 24px; color:var(--slate-700); margin: 0 0 8px; position:relative; display:inline-block; }
    .section-title::after{ content:""; display:block; height:4px; width:56px; border-radius:999px; margin-top:6px;
      background: linear-gradient(90deg, var(--primary), rgba(15,56,77,.1)); }
    .section-sub { color:#64748b; margin: 0 0 18px; }

    .cards { display:grid; grid-template-columns: repeat(3,1fr); gap:16px; }
    .card { background:#fff; border-radius: var(--radius); padding:16px; box-shadow: var(--shadow); border:1px solid var(--slate-200); position:relative; }
    .card::before{ content:""; position:absolute; inset:0 0 auto 0; height:6px; border-radius:14px 14px 0 0;
      background: linear-gradient(90deg, var(--teal-200), var(--sky-200), var(--amber-200)); opacity:.7; }
    .card h3 { margin:8px 0 6px; font-size:18px; color:var(--slate-700); }
    .card p { margin:0; color:#616e7c; font-size:15px; }

    .steps { display:grid; grid-template-columns: repeat(4,1fr); gap:14px; }
    .step { background:#fff; border:1px solid var(--slate-200); border-radius: 14px; padding:14px; box-shadow: var(--shadow); position:relative; }
    .step .num { display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border-radius:999px; font-weight:800; 
      background:linear-gradient(135deg, var(--sky-200), var(--teal-200)); color:#083344; font-size:14px; box-shadow: inset 0 0 0 2px #fff; }
    .step h4 { margin:8px 0 6px; font-size:16px; }
    .step p { margin:0; color:#64748b; font-size:14px; }

    .reviews { display:grid; gap:16px; margin-top:20px; }
    .review { background:#fff; border-radius: var(--radius); padding:16px; box-shadow: var(--shadow); border:1px solid var(--slate-200); position:relative; }
    .review::before{ content:""; position:absolute; left:0; top:0; bottom:0; width:6px; border-radius:14px 0 0 14px; background:linear-gradient(180deg, var(--amber-200), var(--rose-200)); opacity:.8; }
    .review-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .review-name { font-weight:700; color:#0F384D; }
    .stars { color:#f59e0b; }

    .form-wrap { background:#fff; border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid var(--slate-200); padding: 18px; }
    form .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 720px) { form .grid.two { grid-template-columns: 1fr 1fr; } }
    label { display:block; font-weight:700; font-size:14px; color:var(--slate-700); margin-bottom:6px; }
    .hint { font-size:12px; color:#6b7280; margin-top:4px; }

    input[type="text"], input[type="email"], input[type="tel"], input[type="datetime-local"], textarea, select {
      width:100%; padding:12px 12px; border-radius:10px; border:1px solid #d7dee6; outline: none; background:#fbfdff; font-size:15px; font-family:'Antic Slab', serif;
      transition: box-shadow .2s ease, border-color .2s ease;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(15,56,77,.12); }
    textarea { min-height: 110px; resize: vertical; }
    .check-group { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
    .checkbox { display:flex; align-items:flex-start; gap:10px; background:#f9fbfd; border:1px solid #e6eef5; padding:10px 12px; border-radius:10px; }

    /* ✅ Styles applicables aussi aux inputs du picker custom */
    .datetime { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .datetime input[type="text"] {
      width: 100%; padding: 12px 12px; border-radius: 10px; border: 1px solid #d7dee6; background: #fbfdff;
      font-size: 16px; font-family: 'Antic Slab', serif; transition: box-shadow .2s ease, border-color .2s ease;
    }
    .datetime input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(15,56,77,.12); }

    /* ✅ Légère augmentation de la case à cocher (consentement) */
    .consent{ display:flex; align-items:flex-start; gap:10px; }
    #consent{
      transform: scale(1.25);
      transform-origin: top left;
    }

    /* ✅ Message de confirmation plus lisible */
    #formStatus{
      font-size: 16px;
      font-weight: 700;
    }

    /* Footer / Cookies / Responsive (inchangés) */
    footer { color:#64748b; font-size: 13px; text-align:center; padding: 22px 12px 32px; border-top:1px solid var(--slate-200); background:#fff; }
    footer .links { display:flex; justify-content:center; gap:16px; flex-wrap:wrap; }
    #cookie-banner { position: fixed; bottom: 20px; right: 20px; max-width: 320px; background: #222; color: #fff;
      padding: 15px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); z-index: 10000; font-size: 14px; display: none; }
    #cookie-banner .cookie-buttons { margin-top: 10px; text-align: right; }
    #cookie-banner button { margin-left: 5px; padding: 8px 12px; border: none; border-radius: 999px; cursor: pointer; font-weight: bold; }
    #cookie-accept { background: #28a745; color: #fff; }
    #cookie-reject { background: #dc3545; color: #fff; }
    #cookie-accept:hover, #cookie-reject:hover { filter: brightness(0.95); }
    @media (max-width: 920px){ .hero-grid{ grid-template-columns: 1fr; } }
    @media (max-width: 720px){ .steps{ grid-template-columns: repeat(2,1fr);} .cards{ grid-template-columns: 1fr; } }

    #sendEmailNow { font-size: 19px; }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container nav">
      <div class="brand"><img src="logo.png" alt="Logo Bulle de Savon" /></div>
      <div class="cta-header">
        <a class="btn btn-ghost" href="tel:+33618100807">📞 06 18 10 08 07</a>
        <a class="btn btn-primary" href="#devis">Demander une visite & devis</a>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="container hero-grid">
      <div>
        <h2>Nettoyage de vitres pour <em>particuliers</em> & <em>professionnels</em></h2>
        <p class="lead">Fini la prestation à l'heure. Ici, on vient voir, on conseille, et on fixe un <strong>prix juste</strong> sur place — sans mauvaise surprise.</p>
        <div class="badges">
          <span class="badge">✅ Intervention locale</span>
          <span class="badge">🧼 Matériel pro</span>
          <span class="badge">💬 Devis gratuit & rapide</span>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <a class="btn btn-primary" href="#devis">Je veux un devis sur place</a>
          <a class="btn btn-ghost" href="#etapes">Voir les avis</a>
        </div>
      </div>

      <div class="hero-card">
        <div class="usp">
          <div class="item"><div class="icon">🏠</div><div>
            <strong>Particuliers</strong><br><span class="muted">Fenêtres, baies vitrées, vérandas, velux…</span>
          </div></div>
          <div class="item"><div class="icon">🏪</div><div>
            <strong>Commerces</strong><br><span class="muted">Vitrines, portes automatiques, garde-corps…</span>
          </div></div>
          <div class="item"><div class="icon">🧽</div><div>
            <strong>Finition soignée</strong><br><span class="muted">Angles, encadrements, traces difficiles</span>
          </div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Services -->
  <section class="container" id="services">
    <h3 class="section-title">Prestations principales</h3>
    <p class="section-sub">Dites-nous ce dont vous avez besoin : nous passons, évaluons sur place, puis nous vous donnons le prix exact.</p>
    <div class="cards">
      <article class="card"><h3>Vitres & fenêtres</h3><p>Intérieur / extérieur, encadrements et finitions incluses.</p></article>
      <article class="card"><h3>Baies vitrées & vérandas</h3><p>Grands formats, accès difficile, perches télescopiques et escabeau.</p></article>
      <article class="card"><h3>Vitrines de commerces</h3><p>Entretien régulier ou passage ponctuel avant événement.</p></article>
    </div>
  </section>

  <!-- Étapes -->
  <section class="container" id="etapes">
    <h3 class="section-title">Comment ça se passe ?</h3>
    <div class="steps">
      <div class="step"><div class="num">1/4</div><h4>Vous décrivez votre besoin</h4><p>Par téléphone ou en remplissant le formulaire ci-dessous.</p></div>
      <div class="step"><div class="num">2/4</div><h4>Visite rapide</h4><p>On passe sur place pour valider l’accès et la surface.</p></div>
      <div class="step"><div class="num">3/4</div><h4>Prix clair</h4><p>Le tarif est fixé avec vous, sans surprise.</p></div>
      <div class="step"><div class="num">4/4</div><h4>Intervention</h4><p>On intervient au créneau convenu.</p></div>
    </div>
  </section>

  <!-- Avis clients -->
  <section class="container" id="avis">
    <h3 class="section-title">Avis clients</h3>
    <p class="section-sub">Avis vérifiés Google (API Places).</p>
    <div id="googleReviews" class="reviews"></div>
    <div style="margin-top:16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <a id="gmapsLink" class="btn btn-primary" target="_blank" rel="noopener">Voir plus d’avis sur Google</a>
    </div>
  </section>

  <!-- Formulaire -->
  <section class="container" id="devis">
    <h3 class="section-title">Demande de prestation / devis</h3>
    <p class="section-sub">Gratuit et sans engagement. Nous revenons vers vous très vite pour planifier une visite et vous donner le prix exact.</p>
    <div class="form-wrap">
      <form id="requestForm" novalidate>
        <div class="grid two">
          <div>
            <label for="fullname">Nom & prénom *</label>
            <input id="fullname" name="fullname" type="text" autocomplete="name" required>
          </div>
          <div>
            <label for="phone">Téléphone *</label>
            <input id="phone" name="phone" type="tel" inputmode="tel" placeholder="06…" required>
            <div class="hint">On vous appelle seulement pour fixer un créneau.</div>
          </div>
        </div>

        <div class="grid two">
          <div>
            <label for="email">Email</label>
            <input id="email" name="email" type="email" autocomplete="email" placeholder="contact@exemple.fr">
          </div>
          <div>
            <label for="clientType">Vous êtes *</label>
            <select id="clientType" name="clientType" required>
              <option value="">Sélectionner…</option>
              <option>Particulier</option>
              <option>Professionnel</option>
              <option>Association / Copropriété</option>
            </select>
          </div>
        </div>

        <div>
          <label for="address">Adresse d’intervention *</label>
          <input id="address" name="address" type="text" placeholder="N°, rue, ville" required>
          <div class="hint">Précisez l’étage et les informations d’accès si utile.</div>
        </div>

        <div class="grid two">
          <div>
            <label for="slotDate">Créneau souhaité</label>
            <div class="datetime">
              <!-- ⬇️ Passés en type="text" pour activer Flatpickr -->
              <input id="slotDate" name="slotDate" type="text" placeholder="Choisir une date (lun–mer)" />
              <input id="slotTime" name="slotTime" type="text" placeholder="Choisir une heure (06:00–16:00)" />
            </div>
            <!-- On conserve le champ “slot” attendu par le backend/EmailJS -->
            <input id="slot" name="slot" type="hidden">
          </div>
          <div>
            <label for="frequency">Fréquence</label>
            <select id="frequency" name="frequency">
              <option value="Ponctuel">Ponctuel</option>
              <option value="Mensuel">Mensuel</option>
              <option value="Trimestriel">Trimestriel</option>
              <option value="Semestriel">Semestriel</option>
            </select>
          </div>
        </div>

        <div>
          <label for="message">Précisions utiles</label>
          <textarea id="message" name="message" placeholder="Surface approximative, accès, hauteur, traces spécifiques, etc."></textarea>
        </div>

        <!-- Anti-spam honeypot -->
        <input type="text" id="company" name="company" style="position:absolute; left:-9999px; top:-9999px;" tabindex="-1" autocomplete="off" aria-hidden="true">

        <div class="consent">
          <input id="consent" type="checkbox" required>
          <label for="consent">J’accepte d’être contacté par Bulle de Savon pour ma demande. Mes données ne seront pas partagées à des tiers. (<a href="mentions-legales.html">Confidentialité</a>)</label>
        </div>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:6px;">
          <button class="btn btn-primary" type="button" id="sendEmailNow">Envoyer ma demande de devis</button>
          <span id="formStatus" class="hint"></span>
        </div>
      </form>
    </div>
  </section>

  <!-- FAQ -->
  <section class="container" id="faq">
    <h3 class="section-title">Questions fréquentes</h3>
    <details>
      <summary>Comment calculez-vous le tarif ?</summary>
      <p>Nous venons sur place pour évaluer l’accès, la surface et l’état des vitres. Le prix est fixé et validé avec vous avant toute intervention.</p>
    <details>
    <details>
    <summary>Jusqu'à quelle hauteur intervenez vous ?</summary>
      <p>Nous intervenons jusqu'à une hauteur de 4 mètres depuis le sol d’accès.</p>
    <details>
    <details>
      <summary>Faut-il être présent ?</summary>
      <p>Idéalement pour la première visite, oui. Ensuite, nous pouvons convenir d’un mode d’accès sécurisé.</p>
    <details>
    <details>
      <summary>Quelles sont vos horaires d'interventions ?</summary>
      <p>Du lundi au mercredi de 6h à 16h.</p>
    </details>
  </section>

  <!-- Footer -->
  <footer>
    <div class="links">
      <a href="mentions-legales.html">Mentions légales & Politique de confidentialité</a>
      <span>•</span>
      <a href="mailto:contact@bulle-de-savon.fr">contact@bulle-de-savon.fr</a>
      <span>•</span>
      <a href="tel:+33618100807">06 18 10 08 07</a>
      <span>•</span>
      <a href="#devis">Demander un devis</a>
    </div>
  </footer>

  <!-- ✅ Bannière cookies -->
  <div id="cookie-banner">
    🍪 Ce site utilise des cookies pour mesurer l’audience (Google Analytics).
    <div class="cookie-buttons">
      <button id="cookie-accept">Accepter</button>
      <button id="cookie-reject">Refuser</button>
    </div>
  </div>

  <!-- ✅ EmailJS SDK + init -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>(function(){ emailjs.init("P5p4M_38kKjmuJPjz"); })();</script>

  <!-- ======== JS page ======== -->
  <script>
    // Smooth scroll
    document.querySelectorAll('a[href^="#"]').forEach(a => {
      a.addEventListener('click', e => {
        const id = a.getAttribute('href');
        if (id.length > 1) {
          e.preventDefault();
          document.querySelector(id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });

    // Form handling
    const form = document.getElementById('requestForm');
    const statusEl = document.getElementById('formStatus');
    const FORM_ENDPOINT = '';
    let FORCE_EMAILJS = false;

    // ✅ Flatpickr — Griser jours/horaires hors plage
    const slotDateEl = document.getElementById('slotDate');
    const slotTimeEl = document.getElementById('slotTime');

    // Date: autoriser uniquement Lun(1) → Mer(3)
    flatpickr.localize(flatpickr.l10ns.fr);
    const fpDate = flatpickr(slotDateEl, {
      dateFormat: "Y-m-d",
      disableMobile: true,
      disable: [
        function(date){
          const d = date.getDay(); // 0=Dim .. 6=Sam
          return (d === 0 || d >= 4); // gris + inactif sauf lun, mar, mer
        }
      ]
    });

    // Heure: limiter à 06:00–16:00, pas d'autres heures
    const fpTime = flatpickr(slotTimeEl, {
      enableTime: true,
      noCalendar: true,
      dateFormat: "H:i",
      time_24hr: true,
      minuteIncrement: 15,
      minTime: "06:00",
      maxTime: "16:00",
      disableMobile: true
    });

    // Bouton d'envoi direct via EmailJS
    document.getElementById('sendEmailNow')?.addEventListener('click', () => {
      FORCE_EMAILJS = true;
      statusEl.textContent = 'Envoi en cours…';
      statusEl.style.color = '#64748b';
      if (form?.requestSubmit) form.requestSubmit();
      else form?.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
    });

    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        statusEl.textContent = '';
        FORCE_EMAILJS = true;

        // Anti-spam
        if (document.getElementById('company').value.trim() !== '') return;

        // Validation minimale
        const requiredIds = ['fullname','phone','clientType','address','consent'];
        for (const id of requiredIds) {
          const el = document.getElementById(id);
          if ((el.type === 'checkbox' && !el.checked) || (el.value || '').trim() === '') {
            el.focus();
            statusEl.textContent = (id === 'consent')
              ? 'Merci de cocher la case de consentement pour pouvoir envoyer.'
              : 'Merci de compléter les champs marqués *.';
            statusEl.style.color = '#ef4444';
            FORCE_EMAILJS = false;
            return;
          }
        }

        // Recomposer "slot" depuis les champs visibles
        const slotDate = slotDateEl?.value || '';
        const slotTime = slotTimeEl?.value || '';
        document.getElementById('slot').value = (slotDate && slotTime) ? `${slotDate}T${slotTime}` : (slotDate || '');

        // Vérifie EmailJS
        if (!window.emailjs) {
          statusEl.textContent = "Le module d'envoi (EmailJS) ne s'est pas chargé. Réessayez ou utilisez l'email direct.";
          statusEl.style.color = '#ef4444';
          return;
        }

        const data = new FormData(form);
        const services = Array.from(form.querySelectorAll('input[name="services"]:checked')).map(el => el.value).join(', ');

        const payload = {
          customer_name: data.get('fullname') || '',
          customer_email: data.get('email') || '',
          fullname: data.get('fullname') || '',
          email: data.get('email') || '',
          phone: data.get('phone') || '',
          clientType: data.get('clientType') || '',
          address: data.get('address') || '',
          slot: data.get('slot') || '',
          frequency: data.get('frequency') || 'Ponctuel',
          services: services || '—',
          message: data.get('message') || '—',
          to_email: 'contact@bulle-de-savon.fr'
        };

        console.log('Payload EmailJS ->', payload);

        try {
          statusEl.textContent = 'Envoi via EmailJS…';
          statusEl.style.color = '#64748b';
          await emailjs.send('service_b7vi3ol', 'template_wxnjg9e', payload);
          form.reset();
          statusEl.textContent = 'Merci ! Votre demande a bien été envoyée. Nous vous recontactons très vite.';
          statusEl.style.color = '#16a34a';
        } catch (err) {
          const subject = encodeURIComponent('Demande de prestation vitres');
          const body = encodeURIComponent(
`Nom: ${payload.fullname}
Téléphone: ${payload.phone}
Email: ${payload.email}
Type: ${payload.clientType}
Adresse: ${payload.address}
Créneau souhaité: ${payload.slot}
Fréquence: ${payload.frequency}
Prestations: ${payload.services}
Message: ${payload.message}`
          );
          try {
            window.location.href = `mailto:${payload.to_email}?subject=${subject}&body=${body}`;
            statusEl.textContent = "Si rien ne s'ouvre, aucun client mail n'est configuré sur cet appareil.";
            statusEl.style.color = '#64748b';
          } catch {
            statusEl.textContent = "Échec de l'envoi. Vous pouvez nous joindre au 06 18 10 08 07 ou par email.";
            statusEl.style.color = '#ef4444';
          }
        } finally {
          FORCE_EMAILJS = false;
        }
      });
    }
  </script>

  <!-- === Avis Google dynamiques — filtrage robuste pour ta fiche === -->
  <script>
    const GOOGLE_PLACES = {
      API_KEY: 'AIzaSyDkaBdmo0KQ8iWol2ZIgUKEsOIhe2tld-M',
      PLACE_ID: 'ChIJBU4SvmCv9oERPHIX2gvzLkE',
      TARGET_NAME: 'Bulle de Savon',
      CITY_FILTER: 'Maisons-Alfort',
      POSTAL_FILTER: '94700',
      TYPES_EXCLUDE: ['laundry','dry_cleaner','car_wash','beauty_salon'],
      QUERY_VARIANTS: [
        'Bulle de Savon, 94700 Maisons-Alfort',
        '"Bulle de Savon" nettoyage de vitres Maisons-Alfort',
        'Bulle de Savon vitres Maisons-Alfort 94700'
      ],
      LOCATION: { lat: 48.79, lng: 2.45 },
      SEARCH_RADIUS: 12000,
      MAX_REVIEWS: 6
    };

    const norm = s => (s || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();

    function looksLikeOurs(result){
      const nameOk = norm(result.name) === norm(GOOGLE_PLACES.TARGET_NAME);
      const addr = norm(result.formatted_address || result.vicinity || '');
      const cityOk = GOOGLE_PLACES.CITY_FILTER && addr.includes(norm(GOOGLE_PLACES.CITY_FILTER));
      const zipOk = GOOGLE_PLACES.POSTAL_FILTER && addr.includes(GOOGLE_PLACES.POSTAL_FILTER); /* ✅ corrigé */
      const types = (result.types || []).map(norm);
      const bad = GOOGLE_PLACES.TYPES_EXCLUDE.some(t => types.includes(norm(t)));
      return nameOk && (cityOk || zipOk) && !bad;
    }

    function renderPlace(place){
      const reviewsEl = document.getElementById('googleReviews');
      const linkEl = document.getElementById('gmapsLink');

      if (!place){
        reviewsEl.innerHTML = '<div class="review">Impossible de charger les avis pour le moment.</div>';
        linkEl.href = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(GOOGLE_PLACES.QUERY_VARIANTS[0]);
        return;
      }

      const list = (place.reviews || []).slice(0, GOOGLE_PLACES.MAX_REVIEWS);
      reviewsEl.innerHTML = list.length ? '' : '<div class="review">Aucun avis publié pour l’instant.</div>';

      list.forEach(r => {
        const el = document.createElement('div');
        el.className = 'review';
        el.innerHTML = `
<div class="review-header">
  <span class="review-name">${r.author_name || 'Client Google'}</span>
  <span class="stars" aria-label="${r.rating} étoiles">
    ${'★'.repeat(Math.round(r.rating))}${'☆'.repeat(5 - Math.round(r.rating))}
  </span>
</div>
<p>${r.text || ''}</p>
<div class="hint">${new Date(r.time*1000).toLocaleDateString('fr-FR')}</div>
`;
        reviewsEl.appendChild(el);
      });

      linkEl.href = place.url || ('https://www.google.com/maps/place/?q=place_id:' + (place.place_id || ''));
      linkEl.textContent = `Voir ${place.user_ratings_total || ''} avis sur Google`;
    }

    function initGoogleReviews(){
      const reviewsEl = document.getElementById('googleReviews');
      const linkEl = document.getElementById('gmapsLink');
      const svc = new google.maps.places.PlacesService(document.createElement('div'));

      function getDetailsChecked(placeId, onFallback){
        svc.getDetails({ placeId, fields: ['name','rating','user_ratings_total','url','reviews','place_id','formatted_address','geometry','types'] },
          (place, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && place && looksLikeOurs(place)) {
              renderPlace(place);
            } else {
              onFallback?.();
            }
        });
      }

      function searchRobust(){
        const loc = new google.maps.LatLng(GOOGLE_PLACES.LOCATION.lat, GOOGLE_PLACES.LOCATION.lng);
        const variants = GOOGLE_PLACES.QUERY_VARIANTS.slice();

        function tryNext(){
          const q = variants.shift();
          if (!q) {
            reviewsEl.innerHTML = '<div class="review">Fiche introuvable (nom trop proche d’autres entreprises). Donnez-moi votre Place ID exact et je le verrouille.</div>';
            linkEl.href = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(GOOGLE_PLACES.QUERY_VARIANTS[0]);
            return;
          }

          svc.findPlaceFromQuery(
            { query: q, fields:['place_id','name','formatted_address','types'], locationBias: loc },
            (res, status) => {
              if (status === google.maps.places.PlacesServiceStatus.OK && res && res.length){
                const cand = res.find(looksLikeOurs) || res[0];
                return getDetailsChecked(cand.place_id, textSearch);
              }
              textSearch();
            }
          );

          function textSearch(){
            svc.textSearch(
              { query: q, location: loc, radius: GOOGLE_PLACES.SEARCH_RADIUS },
              (results, st) => {
                if (st === google.maps.places.PlacesServiceStatus.OK && results && results.length){
                  const cand = results.find(looksLikeOurs) || results[0];
                  return getDetailsChecked(cand.place_id, tryNext);
                }
                tryNext();
              }
            );
          }
        }
        tryNext();
      }

      if (GOOGLE_PLACES.PLACE_ID) {
        getDetailsChecked(GOOGLE_PLACES.PLACE_ID, searchRobust);
      } else {
        searchRobust();
      }
    }

    (function loadMaps(){
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_PLACES.API_KEY}&libraries=places&language=fr&callback=initGoogleReviews`;
      s.async = true;
      s.defer = true;
      s.onerror = () => {
        const reviewsEl = document.getElementById('googleReviews');
        const linkEl = document.getElementById('gmapsLink');
        if (reviewsEl) reviewsEl.innerHTML = '<div class="review">Google Maps JS ne s’est pas chargé (clé / restrictions ?).</div>';
        if (linkEl) linkEl.href = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(GOOGLE_PLACES.QUERY_VARIANTS[0]);
      };
      document.head.appendChild(s);
    })();
  </script>

  <!-- Cookies / Analytics -->
  <script>
    const cookieBanner = document.getElementById("cookie-banner");
    const acceptBtn = document.getElementById("cookie-accept");
    const rejectBtn = document.getElementById("cookie-reject");

    function loadAnalytics() {
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-PC3K8HGL');

      var gaScript = document.createElement("script");
      gaScript.async = true;
      gaScript.src = "https://www.googletagmanager.com/gtag/js?id=G-NGR43J81FE";
      document.head.appendChild(gaScript);

      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', 'G-NGR43J81FE', { 'anonymize_ip': true });
    }

    const cookieChoice = localStorage.getItem("cookiesAccepted");
    if (cookieChoice === "true") {
      loadAnalytics();
      cookieBanner.style.display = "none";
    } else if (cookieChoice === "false") {
      cookieBanner.style.display = "none";
    } else {
      cookieBanner.style.display = "block";
    }

    acceptBtn?.addEventListener("click", () => {
      localStorage.setItem("cookiesAccepted", "true");
      loadAnalytics();
      cookieBanner.style.display = "none";
    });

    rejectBtn?.addEventListener("click", () => {
      localStorage.setItem("cookiesAccepted", "false");
      cookieBanner.style.display = "none";
    });
  </script>

  <!-- Service Worker (racine) -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(reg => console.log("✅ Service Worker enregistré :", reg))
        .catch(err => console.error("❌ Erreur Service Worker :", err));
    }
  </script>
</body>
</html>
